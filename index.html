<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>The Legend of Dacity</title>

		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="The Legend of Dacity HTML5 game">
		<meta name="author" content="Scott Robert Lawrence">

		<!-- Le styles -->
		<link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
		<style>
			body {
				padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
			}
		</style>

		<!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
		<!--[if lt IE 9]>
		<script src="bootstrap/js/html5shiv.js"></script>
		<![endif]-->

		<!-- Fav and touch icons -->
		<link rel="apple-touch-icon-precomposed" sizes="144x144" href="bootstrap/ico/apple-touch-icon-144-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="bootstrap/ico/apple-touch-icon-114-precomposed.png">
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="bootstrap/ico/apple-touch-icon-72-precomposed.png">
		<link rel="apple-touch-icon-precomposed" href="bootstrap/ico/apple-touch-icon-57-precomposed.png">
		<link rel="shortcut icon" href="bootstrap/ico/favicon.png">

		<script>
      /*window.onerror = function(msg, url, line) {
       msg = msg.replace(/^Uncaught /, '')
       // TODO(fredsa): Make this prettier, log to the server
       if (document.body) {
       var err = document.createElement('div');
       msg = msg.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
       err.innerHTML = '<div style="position: absolute; left: 50%; width: 80em; margin-left: -40em; color: red; ';
       err.innerHTML += 'background-color: white; border: 1px solid red; padding: 4px; font-family: sans-serif; white-space: pre; z-index: 1000;">' + msg + '</div>';
       document.body.appendChild(err);
       } else {
       alert("Grits says, \"Guess what just happened?\"\n" + "----------\n" + msg + "\n" + "----------\n" + url + "\n" + "line number " + line + "\n");
       }
       return false;
       } */
		</script>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
		<script type="text/javascript" src="./scripts/yepnope.1.5.3-min.js"></script>
		<!-- <script type="text/javascript" src="./scripts/mrdoob-stats.js"></script> -->

		<script async>
      // http://paulirish.com/2011/requestanimationframe-for-smart-animating/
      window.requestAnimFrame = (function() {
        return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
        function(/* function */callback, /* DOMElement */element) {
          window.setTimeout(callback, 1000 / 60);
        };
      })();
		</script>

		<script type="text/javascript" id="GENERALJS">
      //-----------------------------------------
      var $doc = function(selector) {
        return selector.charAt(0) == '#' ? document.getElementById(selector.substr(1)) : document.getElementsByTagName(selector);
      };

      //-----------------------------------------
      var $new = function(name) {
        return document.createElement(name);
      };

      function checkWait(conditionFunction, resultFunction) {
        var tev = setInterval(function() {
          if (conditionFunction()) {
            resultFunction();
            clearInterval(tev)
          }
        }, 1000);
      }

		</script>
		<!-- AUTH / LOGIN -->
		<script type="text/javascript" src="./scripts/pregame/oauthlogin.js"></script>
		<script type="text/javascript" src="./scripts/pregame/social.js"></script>
		<script type="text/javascript" src="./scripts/pregame/xhr.js"></script>
		<script type="text/javascript" src="./scripts/pregame/assetloader.js"></script>
		<script type="text/javascript" src="./shared/core/core.js"></script>
		<script type="text/javascript" src="./scripts/core/soundManager.js"></script>
		<script type="text/javascript">
      xhrGet("./shared/weapons/Weapons.json", false, function(resp) {
        eval('gWeapons_DB = ' + resp.responseText);
      });
		</script>

		<script type="text/javascript">
      IS_SERVER = true;
      IS_CLIENT = true;

      var init = function() {

        gSM.init();
        /* var sound = gSM.loadAsync("./sound/bg_menu.ogg", function(s) {
         gSM.playSound("./sound/bg_menu.ogg", {
         looping : true,
         volume : 0.25
         });
         }); */
        var menu_bump = gSM.loadAsync("./sound/menu_bump.ogg", function() {
        });
        var menu_select = gSM.loadAsync("./sound/menu_select.ogg", function() {
        });

      }
      //-----------------------------------------
      document_onload = function() {

        $(document).bind("contextmenu", function(e) {
          return false;
        });

        //popupOnPageLoad();

        init();
      };

      //var showDoobStats = function() {

      //  mrdoob_stats.getDomElement().style.position = 'absolute';
      //  mrdoob_stats.getDomElement().style.left = '100px';
      //  mrdoob_stats.getDomElement().style.top = '0px';
      //  document.body.appendChild(mrdoob_stats.getDomElement());
      //}
      //------------------
      //var loadGame = function(gameURL, player_game_key) {
      var play_game = function() {

        //mrdoob_stats = new Stats();

        var inputScripts = [
        // Shared scripts
        "./shared/core/core.js", "./shared/core/box2D.js", "./shared/core/Constants.js", "./shared/core/Factory.js", "./shared/core/Timer.js", "./shared/core/Entity.js", "./shared/core/GameEngine.js", "./shared/core/PhysicsEngine.js", "./shared/core/Player.js", "./shared/core/TileMap.js", "./shared/core/Weapon.js", "./shared/core/WeaponInstance.js", "./shared/core/Logger.js", "./shared/core/Util.js",

        //"./shared/maps/map1.js", 
        "./shared/environment/SpawnPoint.js", "./shared/environment/Teleporter.js", "./shared/environment/Spawner.js", "./shared/items/HealthCanister.js", "./shared/items/EnergyCanister.js", "./shared/items/QuadDamage.js", "./shared/weapons/Landmine.js", "./shared/weapons/ShotGun.js", "./shared/weapons/RocketLauncher.js", "./shared/weapons/Shield.js", "./shared/weapons/Thrusters.js", "./shared/weapons/ChainGun.js", "./shared/weapons/MachineGun.js", "./shared/weapons/Sword.js", "./shared/weapons/BounceBallGun.js", "./shared/weaponinstances/SimpleProjectile.js", "./shared/weaponinstances/BounceBallBullet.js", "./shared/weaponinstances/LandmineDisk.js", "./shared/weaponinstances/Shield.js", "./shared/weaponinstances/Sword.js",

        //CLM note , we need to load the client scripts AFTER the shared scripts
        //allowing them to overload any global objects defined above.
        // Client-side scripts
        "./scripts/core/ClientGameEngine.js", "./scripts/core/ClientPlayer.js", "./scripts/core/InputEngine.js", "./scripts/core/RenderEngine.js", "./scripts/core/SpriteSheet.js", "./scripts/gui/HotSpot.js", "./scripts/gui/LightBox.js", "./scripts/gui/GuiEngine.js", "./scripts/effects/InstancedEffect.js", "./scripts/effects/PlayerSpawnEffect.js", "./scripts/effects/QuadPowerEffect.js", "./scripts/effects/ClientBounceBallImpact.js", "./scripts/items/ClientHealthCanister.js", "./scripts/items/ClientEnergyCanister.js", "./scripts/items/ClientQuadDamage.js", "./scripts/weapons/ShotGun.js", "./scripts/weapons/ClientLandmine.js", "./scripts/weapons/ClientChainGun.js", "./scripts/weapons/ClientRocketLauncher.js", "./scripts/weapons/ClientMachineGun.js", "./scripts/weapons/ClientBounceBallGun.js", "./scripts/weapons/Thrusters.js", "./scripts/weaponinstances/ClientBounceBallBullet.js", "./scripts/weaponinstances/ClientLandmineDisk.js",

        // Misc scripts
        //gameURL + "/../socket.io/socket.io.js", gameURL + "/../protoize.js",
        "./shared/core/loop.js"];

        yepnope({
          load : inputScripts,
          complete : function() {
            gGameEngine.preloadAssets();
            checkWait(function() {
              return gGameEngine.preloadComplete;
            }, function() {
              gameLoadComplete(/*gameURL, player_game_key*/);
            });
          }
        });

      };
      function readyToRock() {

        Logger.log("Ready to rock");

        //kick off our animation
        requestAnimFrame(run);

        /* loop_run(1000, function() {
         gGameEngine.gSocket.send_ping({
         now : new Date().getTime()
         });
         }); */
      }

      var gameLoadComplete = function(/*gameURL, player_game_key*/) {

        var packet_handler = {
          welcome : function(msg) {
            console.log(msg);
            var p0 = gGameEngine.namedEntities[msg.youare];
            if (!p0)
              alert('no player ' + msg.youare);
            p0.toOthers = p0.toAll = gGameEngine.gSocket;
            p0.color = msg.color;
            gGameEngine.gPlayer0 = p0;
            readyToRock();

            Logger.log("welcome " + msg.youare);
          },
          pong : function(msg) {
            var now = new Date().getTime();
            var lag = now - msg.now;
            //Logger.log('lag = ' + lag);
          },
          wasd : function(msg) {
            //console.log('>>>>>>>>>>>>>>>>>>>>WASD: ', msg);
            for (c in msg) {
              evt = document.createEvent("Events");
              evt.initEvent(msg[c] ? 'keydown' : 'keyup', true, true);
              evt.view = window;
              evt.keyCode = c.charCodeAt(0);
              evt.charCode = c.charCodeAt(0);
              window.dispatchEvent(evt);
            }
          },
          spawn : function(msg) {
            console.log(msg);
            gGameEngine.spawnEntity(msg.type, msg.x, msg.y, JSON.parse(msg.settings));
          },
          unspawn : function(msg) {
            console.log(msg);
            gGameEngine.unspawnPlayer(msg.id);
          },
          collision : function(msg) {
            console.log(msg);
            gGameEngine.on_collision(msg);
          },
          statusMsg : function(msg) {
            console.log(msg);
            printMsg(msg.msg);
          },
          DEFAULT : function(msg, name) {
            console.log(msg, name);
            if (msg.from) {
              var ent = gGameEngine.namedEntities[msg.from];
              if (!ent) {
                Logger.log("no entity named '" + msg.from + "'");
              } else if (ent['on_' + name]) {
                ent['on_'+name](msg);
              }
            }
          }
        };

		window.packet_handler = packet_handler;
        //disablePopup();
        //load our game and move the world forward.

        //document.getElementById("impress").style.display = "none";
        //document.getElementById('welcomescreen').style.display = "none";
        var game_canvas = document.getElementById("game_canvas");
        game_canvas.style.display = "block";
        document.body.insertBefore(game_canvas, document.body.firstChild);

        Logger.log("loaded scripts");

        gInputEngine.setup();
        gRenderEngine.setup();
        gGameEngine.setup();
        Logger.log("setup engines");

        gSM.stopAll();
        /* gSM.playSound("./sound/bg_game.ogg", {
        looping : true,
        volume : 0.25
        }); */

        //Logger.log("connecting to server: " + gameURL);
        /* gGameEngine.gSocket = protoize(io.connect(gameURL), packet_handler);
         gGameEngine.gSocket.send_hello({
         player_game_key : player_game_key
         });
         gGameEngine.gSocket.on('disconnect', function() {
         alert("Games server disconnected.");
         window.location.href = "/";
         }); */

		gGameEngine.gSocketFunction = function(type, msg, name){
			console.log(type, msg);
			if (!(type in packet_handler)) {
				type = "DEFAULT";
			}
			packet_handler[type](msg, name);
		}

        gGameEngine.gSocket = {
          q_input : function(msg, name) {
            gGameEngine.gSocketFunction("input", msg, name)
          },
          q_phys : function(msg, name) {
			gGameEngine.gSocketFunction("phys", msg, name)
          },
          sendq : function() {
            console.log("send_q", arguments);
          },
          q_stats : function(msg, name) {
          	gGameEngine.gSocketFunction("stats", msg, name)
          }
        };

        var player = {
          id : "!1",
          type : "Player",
          x : 400,
          y : 400,
          settings : {
            "name" : "!1",
            "team" : 1,
            "userID" : "bot*5094",
            "displayName" : "bot*5094",
            "type" : "Player",
            "hsize" : {
              "x" : 26,
              "y" : 26
            }
          }
        };
        var msg = player;
        gGameEngine.spawnEntity(msg.type, msg.x, msg.y, msg.settings);

        var welcome = function(msg) {
          console.log(msg);
          var p0 = gGameEngine.namedEntities[msg.youare];
          if (!p0)
            alert('no player ' + msg.youare);
          p0.toOthers = p0.toAll = gGameEngine.gSocket;
          p0.color = msg.color;
          gGameEngine.gPlayer0 = p0;
          readyToRock();

          Logger.log("welcome " + msg.youare);
        }
        welcome({
          youare : player.id,
          color : 1
        });

        // Since the server isn't going to tell us that.

      }
      //-----------------------------------------
      var run = function() {
        //check for resizes and adjust accordingly.
        gRenderEngine.canvas.style.position = "absolute";
        gRenderEngine.canvas.style.top = "0";
        if (gRenderEngine.canvas.width != window.innerWidth) {
          gRenderEngine.canvas.width = window.innerWidth;
        }
        if (gRenderEngine.canvas.height != window.innerHeight) {
          gRenderEngine.canvas.height = window.innerHeight;
        }

        gRenderEngine.context.clearRect(0, 0, gRenderEngine.canvas.width, gRenderEngine.canvas.height);
        gGameEngine.run();
        //if (mrdoob_stats)
        //mrdoob_stats.update();
        requestAnimFrame(run);

      };
      //-----------------------------------------
      var msgBoxTimer = null;
      var msgBoxOpacityTimer = null;
      function printMsg(msg) {
        if (msgBoxTimer != null) {
          clearInterval(msgBoxTimer);
          clearInterval(msgBoxOpacityTimer);
        }
        var divv = document.getElementById("msgbox");
        divv.style.opacity = 1.0;
        divv.innerHTML = msg;
        msgBoxTimer = setInterval(function() {
          clearInterval(msgBoxTimer);
          msgBoxOpacityTimer = setInterval(function() {
            divv.style.opacity -= 1.0 / 60;
            if (divv.style.opacity <= 0)
              clearInterval(msgBoxOpacityTimer);

          }, 1000 / 60);
        }, 3000);

      }

      //do not touch this.
      document.addEventListener('DOMContentLoaded', document_onload, false);

      var map = "img/fantasy.json";

      xhrGet(map, false, function(data) {
        parseMapJSON(data.responseText);
      });
      var parseMapJSON = function(mapJSON) {
        window.map1 = JSON.parse(mapJSON);
      }

		</script>

	</head>

	<body>

		<div class="navbar navbar-inverse navbar-fixed-top">
			<div class="navbar-inner">
				<div class="container">
					<button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="brand" href="#">The Legend of Dacity</a>
					<div class="nav-collapse collapse">
						<ul class="nav">
							<li class="active">
								<a href="#">Home</a>
							</li>
							<!-- <li>
							<a href="#about">About</a>
							</li>
							<li>
							<a href="#contact">Contact</a>
							</li> -->
						</ul>
					</div><!--/.nav-collapse -->
				</div>
			</div>
		</div>

		<div class="container">

			<h1>The Legend of Dacity</h1>
			<div id='game_canvas' style="display:none">
				<canvas id='canvas' width="800px" height="600px">
					Available for play on HTML5 enabled browsers such as the Desktop version of Chrome.
				</canvas>
				<div id='canvasui' name='canvasui'>
					<div id='msgbox'>
						&nbsp;
					</div>
				</div>
			</div>
			<a href="#" id="play_button" onclick="playSoundInstance('./sound/bfxr_magic.wav'); play_game(); return false;"
			onmouseover="playSoundInstance('./sound/bfxr_low_coin.wav')"><strong>Play</strong></a>
			<footer class="navbar">
				<p id="contact">
					&copy; Copyright 2013 by <a href="http://bastiandantilus.com" title="View Scott's blog">Scott Robert Lawrence</a>
				</p>
			</footer>

		</div>
		<!-- /container -->

		<!-- Le javascript
		================================================== -->
		<!-- Placed at the end of the document so the pages load faster -->
		<script src="bootstrap/js/bootstrap.min.js"></script>

	</body>
</html>